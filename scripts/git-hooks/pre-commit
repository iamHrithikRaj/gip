#!/bin/bash
#
# Gip Pre-commit Hook
# Checks for clang-format and clang-tidy compliance on staged files.
#

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}[Pre-commit]${NC} Starting checks..."

# Get staged C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(cpp|h|hpp|cc|cxx)$")

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}[Pre-commit]${NC} No C++ files staged. Skipping."
    exit 0
fi

# Check for tools
if ! command -v clang-format &> /dev/null; then
    echo -e "${YELLOW}[Pre-commit]${NC} clang-format not found. Skipping formatting check."
else
    echo -e "${YELLOW}[Pre-commit]${NC} Checking formatting..."
    FORMAT_ISSUES=0
    
    for file in $STAGED_FILES; do
        # Check if file exists (it might have been deleted but still in diff if not updated properly, though diff-filter handles D)
        if [ -f "$file" ]; then
            clang-format --dry-run --Werror "$file" > /dev/null 2>&1
            if [ $? -ne 0 ]; then
                echo -e "${RED}✘ Format error:${NC} $file"
                FORMAT_ISSUES=1
            fi
        fi
    done

    if [ $FORMAT_ISSUES -eq 1 ]; then
        echo -e "${RED}[Pre-commit]${NC} Formatting check failed."
        echo "Please run: clang-format -i <files>"
        exit 1
    fi
fi

# Check for clang-tidy
if ! command -v clang-tidy &> /dev/null; then
    echo -e "${YELLOW}[Pre-commit]${NC} clang-tidy not found. Skipping static analysis."
else
    # Check for compile_commands.json
    BUILD_DIR="build"
    if [ ! -f "$BUILD_DIR/compile_commands.json" ]; then
        # Try to find it in common places
        if [ -f "compile_commands.json" ]; then
            BUILD_DIR="."
        elif [ -f "out/build/x64-Debug/compile_commands.json" ]; then
            BUILD_DIR="out/build/x64-Debug"
        else
            echo -e "${YELLOW}[Pre-commit]${NC} compile_commands.json not found. Skipping clang-tidy."
            echo "Run cmake to generate it."
            exit 0
        fi
    fi

    echo -e "${YELLOW}[Pre-commit]${NC} Running clang-tidy (using $BUILD_DIR)..."
    TIDY_ISSUES=0

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            echo -e "  Checking $file..."
            # Run clang-tidy. We use --quiet to reduce noise, but errors will still show.
            # We filter headers to src/ and include/ to avoid system header noise.
            OUTPUT=$(clang-tidy -p "$BUILD_DIR" --quiet --header-filter='^(src|include)/.*' "$file" 2>&1)
            
            # Check if there were warnings/errors
            if echo "$OUTPUT" | grep -q "warning:\|error:"; then
                echo -e "${RED}✘ Issues found in $file:${NC}"
                echo "$OUTPUT"
                TIDY_ISSUES=1
            fi
        fi
    done

    if [ $TIDY_ISSUES -eq 1 ]; then
        echo -e "${RED}[Pre-commit]${NC} Static analysis failed."
        echo "Please fix the issues above."
        exit 1
    fi
fi

echo -e "${GREEN}[Pre-commit]${NC} All checks passed!"
exit 0
